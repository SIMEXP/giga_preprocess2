#!/bin/bash
#SBATCH --account=rrg-pbellec
#SBATCH --output=/lustre04/scratch/hwang1/logs/%x_%A.out
#SBATCH --error=/lustre04/scratch/hwang1/logs/%x_%A.out
#SBATCH --cpus-per-task=1


GIGA_CONNECTOME_VERSION=0.4.1
SITE=KKI_1
GIGA_CONNECTOME=/lustre03/project/6003287/${USER}/giga_connectome-${GIGA_CONNECTOME_VERSION}.simg
FMRIPREP_DIR=/lustre04/scratch/${USER}/${DATASET}_fmriprep-20.2.7lts/${SITE}
CONNECTOME_OUTPUT=/lustre04/scratch/${USER}/${DATASET}_connectomes-${GIGA_CONNECTOME_VERSION}/

WORKINGDIR=${CONNECTOME_OUTPUT}/working_directory/${SITE}

PARTICIPANTS="29295 29378 29368 29439 29422 29312 29401 29485 29287 29391 29430 29434 29384 29478 29350 29357 29477 29451 29480 29322 29479 29293 29377 29472 29330 29311 29366 29274 29405 29316 29411 29288 29408 29448 29338 29363 29306 29397 29309 29431 29352 29356 29428 29400 29308 29325 29412 29424 29445 29290 29346 29429 29305 29302 29433 29342 29393 29369 29453 29278 29462 29361 29379 29329 29468 29348 29452 29481 29482 29471 29304 29360 29365 29436 29396 29420 29421 29438 29343 29321 29364 29399 29331 29389 29339 29353 29404 29334 29349 29455 29442 29459 29440 29324 29323 29327 29372 29275 29276 29418 29382 29386 29444 29467 29432 29315 29335 29351 29407 29427 29273 29460 29300 29326 29395 29336 29370 29344 29359 29469 29476 29318 29297 29456 29319 29307 29435 29362 29337 29402 29303 29294 29345 29425 29387 29340 29355 29314 29403 29390 29375 29301 29419 29376 29381 29347 29447 29371 29441 29328 29394 29410 29310 29358 29417 29320 29283 29474 29414 29450 29454 29333 29282 29289 29457 29279 29416 29449 29285 29281 29313 29415 29461 29380 29317 29280 29413 29367 29354 29385 29374 29437 29463 29292 29286 29392 29409 29458 29296 29298 29443 29373 29483 29470 29277 29446 29332 29465 29284 29299 29388 29341 29291 29383 29473 29484 29423 29466 29475"  # exclude the subject with no cosine regressor

module load apptainer/1.1.8

mkdir -p $WORKINGDIR

echo "${FMRIPREP_DIR}"
if [ -d "${FMRIPREP_DIR}" ]; then
    mkdir ${WORKINGDIR}
	mkdir ${SLURM_TMPDIR}
	mkdir ${CONNECTOME_OUTPUT}/${SITE}
	echo "=========${STRATEGY}========="
	echo "${ATLAS}"
	apptainer run \
		--bind ${FMRIPREP_DIR}:/data/input \
		--bind ${SLURM_TMPDIR}:/data/output \
		--bind ${WORKINGDIR}:/data/working \
		${GIGA_CONNECTOME} \
		--participant_label ${PARTICIPANTS} \
		-w /data/working \
		--atlas ${ATLAS} \
		--denoise-strategy ${STRATEGY} \
		/data/input \
		/data/output \
		group
	exitcode=$?  # catch exit code
	if [ $exitcode -eq 0 ] ; then rsync -rltv --info=progress2 ${SLURM_TMPDIR}/*.h5 ${CONNECTOME_OUTPUT}/${SITE} ; fi
else
    echo "no preprocessed data for ${SITE}"
fi

